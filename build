#!/bin/bash

rootDir=$(dirname "$0")

env="$1"
if [ -z "$env" ]; then
    echo "Environment is required." >&2
    exit 1
fi
if [ "$env" != "development" ] && [ "$env" != "production" ]; then
    echo "Environment must be 'development' or 'production'." >&2
    exit 1
fi

cp \
    "$(go env GOROOT)/misc/wasm/wasm_exec.js" \
    "${rootDir}/public/wasm_exec.js"

GOOS=js GOARCH=wasm go build \
    -o "${rootDir}/public/main.wasm" \
    "${rootDir}/cmd/client-hypp/main.go"

go run "${rootDir}/cmd/static/main.go" "${rootDir}/public"

GOOS=js GOARCH=wasm go build \
    -o "${rootDir}/cmd/fairytale/main.wasm" \
    "${rootDir}/cmd/fairytale/main.go"

if [ "$env" = "production" ]; then
    sass "${rootDir}/scss:${rootDir}/public"
fi
